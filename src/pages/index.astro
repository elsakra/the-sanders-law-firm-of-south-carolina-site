---
import BaseLayout from '@/layouts/BaseLayout.astro';
import NewsCarousel from '@/components/NewsCarousel.astro';
import ResourcesGrid from '@/components/ResourcesGrid.astro';
import TabbedServices from '@/components/TabbedServices.astro';
import InsightsFeed from '@/components/InsightsFeed.astro';
import siteData from '@/data/site.json';
import { getCollection } from 'astro:content';

const testimonials = await getCollection('testimonials');
const featuredTestimonials = testimonials.filter(t => t.data.featured).slice(0, 2);

// Get blog posts to check if we should show Insights section
const blogPosts = await getCollection('blog');
const hasBlogPosts = blogPosts.length > 0;

// Get services to check if we should show Practice Areas section
const services = await getCollection('services');
const hasServices = services.length > 0;

const { hero, sections, company, news, resources, socialProof } = siteData;
---

<BaseLayout>
  <!-- Hero Section - Editorial split layout -->
  <section class="relative min-h-screen bg-charcoal-950 overflow-hidden">
    <!-- Background Video/Image -->
    {hero.backgroundVideo ? (
      <video
        class="absolute inset-0 w-full h-full object-cover opacity-35"
        autoplay
        muted
        loop
        playsinline
        preload="metadata"
        poster={typeof hero.backgroundVideo === 'string' ? undefined : hero.backgroundVideo.poster}
      >
        <source src={typeof hero.backgroundVideo === 'string' ? hero.backgroundVideo : hero.backgroundVideo.src} />
      </video>
    ) : hero.backgroundImage ? (
      <img 
        src={hero.backgroundImage} 
        alt=""
        class="absolute inset-0 w-full h-full object-cover opacity-35"
      />
    ) : (
      <!-- Abstract gradient background when no media -->
      <div class="absolute inset-0">
        <div class="absolute inset-0 bg-gradient-to-br from-charcoal-950 via-charcoal-900 to-charcoal-950"></div>
        <div class="absolute -top-24 left-1/4 w-[28rem] h-[28rem] bg-primary-500/10 rounded-full blur-[120px]"></div>
        <div class="absolute -bottom-24 right-1/4 w-[22rem] h-[22rem] bg-primary-500/10 rounded-full blur-[120px]"></div>
      </div>
    )}

    <!-- Editorial overlay -->
    <div class="absolute inset-0 bg-gradient-to-r from-charcoal-950/90 via-charcoal-950/75 to-charcoal-950/40"></div>
    
    <!-- Video Controls -->
    {hero.backgroundVideo && (
      <button 
        type="button"
        class="absolute top-28 right-8 text-primary-500 text-sm font-medium hover:text-white transition-colors z-10"
        id="video-toggle"
      >
        Pause video
      </button>
    )}
    
    <!-- Hero Content -->
    <div class="relative z-10 max-w-7xl mx-auto px-6 lg:px-8 pt-28 pb-24 lg:pt-40 lg:pb-32">
      <div class="grid lg:grid-cols-[1.1fr_0.9fr] gap-12 items-end">
        <div>
          <div class="inline-flex items-center gap-3 text-xs uppercase tracking-[0.3em] text-neutral-400">
            <span class="h-px w-10 bg-primary-500/70"></span>
            <span>{company.tagline || "Estate & Elder Law"}</span>
          </div>
          <h1 class="mt-6 font-display text-5xl sm:text-6xl md:text-7xl lg:text-8xl text-white tracking-tight leading-[0.95]">
            {hero.headline}
          </h1>
          <p class="mt-6 text-lg sm:text-xl md:text-2xl text-neutral-300 max-w-2xl leading-relaxed">
            {hero.subheadline || company.description}
          </p>
          <div class="mt-10 flex flex-wrap gap-4">
            <a 
              href={hero.cta?.href || "/contact"}
              class="inline-flex items-center gap-2 px-7 py-4 bg-primary-500 text-charcoal-950 font-semibold tracking-tight hover:bg-primary-400 transition-colors"
            >
              {hero.cta?.label || "Contact Us"}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
            {company.phone && (
              <a 
                href={`tel:${company.phone.replace(/[^\\d+]/g, '')}`}
                class="inline-flex items-center gap-2 px-7 py-4 border border-white/20 text-white font-semibold tracking-tight hover:border-white/50 hover:bg-white/5 transition-colors"
              >
                {company.phone}
              </a>
            )}
          </div>
        </div>
        <div class="bg-white/5 border border-white/10 p-8 lg:p-10 backdrop-blur-sm">
          <div class="text-sm uppercase tracking-[0.25em] text-neutral-400">Practice focus</div>
          <div class="mt-4 space-y-3 text-white/90">
            <div class="flex items-center gap-3">
              <span class="w-1.5 h-1.5 rounded-full bg-primary-500"></span>
              <span>Estate Planning</span>
            </div>
            <div class="flex items-center gap-3">
              <span class="w-1.5 h-1.5 rounded-full bg-primary-500"></span>
              <span>Elder Law & Medicaid</span>
            </div>
            <div class="flex items-center gap-3">
              <span class="w-1.5 h-1.5 rounded-full bg-primary-500"></span>
              <span>Probate & Trust Administration</span>
            </div>
          </div>
          <div class="mt-8 text-sm text-neutral-400">
            {company.address?.city ? `${company.address.city}, ${company.address.state}` : company.address?.state}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Scroll Indicator -->
    <div class="absolute bottom-10 left-8 z-10 hidden md:block">
      <div class="flex items-center gap-4 text-neutral-500">
        <span class="text-xs uppercase tracking-[0.25em]">Scroll</span>
        <div class="w-16 h-px bg-gradient-to-r from-neutral-500 to-transparent"></div>
      </div>
    </div>
  </section>

  <!-- News Carousel -->
  {news && news.length > 0 && (
    <NewsCarousel items={news} />
  )}

  <!-- Resources Grid -->
  {resources && resources.length > 0 && (
    <ResourcesGrid 
      headline="Resources" 
      resources={resources} 
    />
  )}

  <!-- Diversity/Values Section (Cooley-style accent section) -->
  <section class="relative overflow-hidden">
    <div class="grid lg:grid-cols-2">
      <!-- Image/Visual Side -->
      <div class="bg-primary-500 min-h-[400px] lg:min-h-[600px] relative">
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="text-white/10 font-display text-[20rem] font-bold leading-none select-none">
            &
          </div>
        </div>
      </div>
      
      <!-- Content Side -->
      <div class="bg-charcoal-900 py-16 lg:py-24 px-8 lg:px-16 flex items-center">
        <div class="max-w-lg">
          <h2 class="font-display text-3xl md:text-4xl text-white mb-6">
            {sections.about.headline}
          </h2>
          <p class="text-neutral-300 leading-relaxed mb-8">
            {sections.about.content}
          </p>
          
          {sections.about.values && (
            <div class="space-y-4">
              {sections.about.values.slice(0, 3).map((value) => (
                <div class="flex gap-4">
                  <div class="w-1 bg-primary-500 flex-shrink-0"></div>
                  <div>
                    <h3 class="font-semibold text-white">{value.title}</h3>
                    <p class="text-sm text-neutral-400 mt-1">{value.description}</p>
                  </div>
                </div>
              ))}
            </div>
          )}
          
          <a href="/about" class="inline-flex items-center gap-2 mt-8 text-primary-500 font-medium hover:gap-3 transition-all">
            Learn more about us
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Latest Insights (only show if there are blog posts) -->
  {hasBlogPosts && (
    <InsightsFeed headline={sections.insights?.headline || "Latest insights"} limit={5} />
  )}

  <!-- Tabbed Services Section (only show if there are services) -->
  {hasServices && (
    <TabbedServices 
      headline={sections.services?.headline}
      practicesHeadline={sections.services?.practicesHeadline}
      industriesHeadline={sections.services?.industriesHeadline}
    />
  )}

  <!-- Stats Section -->
  {socialProof?.stats && (
    <section class="bg-charcoal-950 py-24">
      <div class="max-w-7xl mx-auto px-6 lg:px-8">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-8 md:gap-12">
          {socialProof.stats.map((stat) => (
            <div class="text-center">
              <p class="font-display text-4xl md:text-5xl lg:text-6xl text-primary-500">
                {stat.value}
              </p>
              <p class="mt-2 text-neutral-400 text-sm uppercase tracking-wider">
                {stat.label}
              </p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Testimonials -->
  {featuredTestimonials.length > 0 && (
    <section class="bg-white py-24">
      <div class="max-w-7xl mx-auto px-6 lg:px-8">
        <h2 class="font-display text-3xl md:text-4xl text-charcoal-950 mb-12">
          {sections.testimonials?.headline || "What our clients say"}
        </h2>
        
        <div class="grid md:grid-cols-2 gap-8">
          {featuredTestimonials.map((testimonial) => (
            <div class="bg-neutral-50 p-8 md:p-10">
              <blockquote class="text-lg text-charcoal-800 leading-relaxed mb-6">
                "{testimonial.data.quote || testimonial.body}"
              </blockquote>
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-charcoal-200 rounded-full flex items-center justify-center">
                  <span class="text-charcoal-600 font-semibold text-lg">
                    {testimonial.data.author?.charAt(0) || "?"}
                  </span>
                </div>
                <div>
                  <p class="font-semibold text-charcoal-900">{testimonial.data.author}</p>
                  {(testimonial.data.role || testimonial.data.company) && (
                    <p class="text-sm text-neutral-500">
                      {[testimonial.data.role, testimonial.data.company].filter(Boolean).join(' Â· ')}
                    </p>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA Section -->
  {sections.cta && (
    <section class="bg-primary-500 py-24">
      <div class="max-w-4xl mx-auto px-6 lg:px-8 text-center">
        <h2 class="font-display text-3xl sm:text-4xl md:text-5xl text-white">
          {sections.cta.headline}
        </h2>
        {sections.cta.description && (
          <p class="mt-6 text-xl text-white/80">
            {sections.cta.description}
          </p>
        )}
        <div class="mt-10 flex flex-wrap justify-center gap-4">
          <a 
            href={sections.cta.cta.href}
            class="inline-flex items-center gap-2 px-8 py-4 bg-white text-charcoal-900 font-semibold hover:bg-neutral-100 transition-colors"
          >
            {sections.cta.cta.label}
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
          {sections.cta.secondaryCta && (
            <a 
              href={sections.cta.secondaryCta.href}
              class="inline-flex items-center gap-2 px-8 py-4 border-2 border-white text-white font-semibold hover:bg-white/10 transition-colors"
            >
              {sections.cta.secondaryCta.label}
            </a>
          )}
        </div>
      </div>
    </section>
  )}
</BaseLayout>

<script>
  // Video toggle functionality
  const videoToggle = document.getElementById('video-toggle');
  const heroVideo = document.querySelector('video');
  
  if (videoToggle && heroVideo) {
    videoToggle.addEventListener('click', () => {
      if (heroVideo.paused) {
        heroVideo.play();
        videoToggle.textContent = 'Pause video';
      } else {
        heroVideo.pause();
        videoToggle.textContent = 'Play video';
      }
    });
  }
</script>
